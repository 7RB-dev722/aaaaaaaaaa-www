import webpush from 'web-push';
import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// Generate VAPID keys
const vapidKeys = webpush.generateVAPIDKeys();
const envPath = path.resolve(__dirname, '../.env');

console.log('\n\x1b[36m=======================================\x1b[0m');
console.log('\x1b[1mðŸ”‘ Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø¯Ø§Ø¯ Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª...\x1b[0m');
console.log('\x1b[36m=======================================\x1b[0m\n');

let envContent = '';
try {
  if (fs.existsSync(envPath)) {
    envContent = fs.readFileSync(envPath, 'utf8');
  } else {
    console.log('\x1b[33mÙ…Ù„Ù .env ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ØŒ Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡.\x1b[0m');
  }

  // Update Public Key in .env
  const publicKeyKey = 'VITE_VAPID_PUBLIC_KEY';
  const publicKeyValue = `"${vapidKeys.publicKey}"`;
  
  if (envContent.includes(publicKeyKey)) {
    // Replace existing key
    envContent = envContent.replace(new RegExp(`${publicKeyKey}=.*`), `${publicKeyKey}=${publicKeyValue}`);
  } else {
    // Append new key
    envContent += `\n${publicKeyKey}=${publicKeyValue}\n`;
  }

  fs.writeFileSync(envPath, envContent);
  console.log(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« \x1b[32m${publicKeyKey}\x1b[0m ÙÙŠ Ù…Ù„Ù .env Ø¨Ù†Ø¬Ø§Ø­.`);

} catch (error) {
  console.error('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ù…Ù„Ù .env:', error);
}

console.log('\n\x1b[33mâš ï¸  Ø®Ø·ÙˆØ© Ù‡Ø§Ù…Ø© Ø¬Ø¯Ø§Ù‹ (Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ø¹Ù…Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª):\x1b[0m');
console.log('ÙŠØ¬Ø¨ Ø¹Ù„ÙŠÙƒ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø³Ø±ÙŠ Ø§Ù„ØªØ§Ù„ÙŠ ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Supabase Edge Function:');
console.log('\n\x1b[41m\x1b[37m VAPID_PRIVATE_KEY \x1b[0m');
console.log('\x1b[32m' + vapidKeys.privateKey + '\x1b[0m');
console.log('\nØ§Ù†Ø³Ø® Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø£Ø®Ø¶Ø± Ø£Ø¹Ù„Ø§Ù‡ ÙˆØ¶Ø¹Ù‡ ÙÙŠ: Supabase Dashboard > Edge Functions > smooth-processor > Secrets');
console.log('\x1b[36m=======================================\x1b[0m\n');
